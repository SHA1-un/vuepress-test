import { isPlainObject } from "@vuepress/shared";
import { useSessionStorage, useStorage } from "@vueuse/core";
import { computed } from "vue";
import { useRoute } from "vue-router";
import { useEncryptData } from "./utils.js";
import { checkToken } from "@theme-hope/modules/encrypt/utils/index";
const STORAGE_KEY = "VUEPRESS_HOPE_PATH_TOKEN";
export const usePathEncrypt = () => {
    const route = useRoute();
    const encryptData = useEncryptData();
    const localToken = useStorage(STORAGE_KEY, {});
    const sessionToken = useSessionStorage(STORAGE_KEY, {});
    const getPathMatchedKeys = (path) => isPlainObject(encryptData.value.config)
        ? Object.keys(encryptData.value.config)
            .filter((key) => decodeURI(path).startsWith(key))
            .sort((a, b) => b.length - a.length)
        : [];
    const getStatus = (path) => {
        const matchedKeys = getPathMatchedKeys(path);
        if (matchedKeys.length !== 0) {
            const { config = {} } = encryptData.value;
            return !matchedKeys.some((key) => (localToken.value[key] &&
                config[key].some((token) => checkToken(localToken.value[key], token))) ||
                (sessionToken.value[key] &&
                    config[key].some((token) => checkToken(sessionToken.value[key], token))));
        }
        return false;
    };
    const isEncrypted = computed(() => getStatus(route.path));
    const validate = (inputToken, keep = false) => {
        const { config = {} } = encryptData.value;
        const matchedKeys = getPathMatchedKeys(route.path);
        for (const hitKey of matchedKeys) {
            // some of the tokens matches
            if (config[hitKey].filter((token) => checkToken(inputToken, token))) {
                (keep ? localToken : sessionToken).value[hitKey] = inputToken;
                break;
            }
        }
    };
    return {
        isEncrypted,
        getStatus,
        validate,
    };
};
//# sourceMappingURL=path.js.map