{"version":3,"file":"ArtPlayer.js","sources":["../../../src/client/composables/size.ts","../../../src/client/utils/mse.ts","../../../src/client/components/ArtPlayer.ts"],"sourcesContent":["import { isString } from \"@vuepress/shared\";\nimport { useEventListener } from \"@vueuse/core\";\nimport { computed, isRef, onMounted, ref, unref, watch } from \"vue\";\n\nimport type { MaybeRef } from \"@vueuse/core\";\nimport type { Ref } from \"vue\";\n\nconst getValue = (value: string | number): string =>\n  isString(value) ? value : `${value}px`;\n\nexport interface SizeOptions {\n  width: string | number | undefined;\n  height: string | number | undefined;\n  ratio: string | number | undefined;\n}\n\nexport interface SizeInfo<E extends HTMLElement> {\n  el: Ref<E | undefined>;\n  width: Ref<string>;\n  height: Ref<string>;\n}\n\nexport const useSize = <E extends HTMLElement>(\n  options: SizeOptions,\n  extraHeight: MaybeRef<number> = 0\n): SizeInfo<E> => {\n  const el = ref<E>();\n  const width = computed(() => getValue(unref(options.width) || \"100%\"));\n  const height = ref(\"auto\");\n\n  const getRadio = (ratio: number | string | undefined): number => {\n    if (isString(ratio)) {\n      const [width, height] = ratio.split(\":\");\n      const parsedRadio = Number(width) / Number(height);\n\n      if (!Number.isNaN(parsedRadio)) return parsedRadio;\n    }\n\n    return typeof ratio === \"number\" ? ratio : 16 / 9;\n  };\n\n  const getHeight = (width: number): string => {\n    const height = unref(options.height);\n    const ratio = getRadio(unref(options.ratio));\n\n    return height\n      ? getValue(height)\n      : `${Number(width) / ratio + unref(extraHeight)}px`;\n  };\n\n  const updateHeight = (): void => {\n    if (el.value) height.value = getHeight(el.value.clientWidth);\n  };\n\n  onMounted(() => {\n    updateHeight();\n    if (isRef(extraHeight)) watch(extraHeight, () => updateHeight());\n    useEventListener(\"orientationchange\", () => updateHeight());\n    useEventListener(\"resize\", () => updateHeight());\n  });\n\n  return {\n    el,\n    width,\n    height,\n  };\n};\n","export const SUPPORTED_VIDEO_TYPES = [\n  \"mp4\",\n  \"mp3\",\n  \"webm\",\n  \"ogg\",\n  \"m3u8\",\n  \"hls\",\n  \"ts\",\n  \"flv\",\n  \"mpd\",\n  \"dash\",\n];\n\nexport const getTypeByUrl = (url: string): string =>\n  url?.split(\".\").pop() || \"\";\n\nexport const registerMseDash = async (\n  mediaElement: HTMLMediaElement,\n  src: string,\n  registerDestroy: (destroy: () => void) => void,\n  autoPlay = false,\n  startTime = 0\n): Promise<void> => {\n  const dashjs = (\n    await import(/* webpackChunkName: \"dashjs\" */ \"dashjs/dist/dash.all.min.js\")\n  ).default;\n\n  if (dashjs.supportsMediaSource()) {\n    const dashPlayer = dashjs.MediaPlayer().create();\n\n    dashPlayer.initialize(mediaElement, src, autoPlay, startTime);\n\n    registerDestroy(() => dashPlayer.destroy());\n  }\n};\n\nexport const registerMseFlv = async (\n  mediaElement: HTMLMediaElement,\n  src: string,\n  registerDestroy: (destroy: () => void) => void\n): Promise<void> => {\n  const mpegts = (\n    await import(/* webpackChunkName: \"mpegts.js\" */ \"mpegts.js/dist/mpegts.js\")\n  ).default;\n\n  if (mpegts.isSupported()) {\n    const flvPlayer = mpegts.createPlayer({\n      type: \"flv\",\n      url: src,\n    });\n\n    flvPlayer.attachMediaElement(mediaElement);\n    flvPlayer.load();\n\n    registerDestroy(() => flvPlayer.destroy());\n  }\n};\n\nexport const registerMseHls = async (\n  mediaElement: HTMLMediaElement,\n  src: string,\n  registerDestroy: (destroy: () => void) => void\n): Promise<void> => {\n  const hls = (\n    await import(/* webpackChunkName: \"hls.js\" */ \"hls.js/dist/hls.min.js\")\n  ).default;\n\n  if (\n    mediaElement.canPlayType(\"application/x-mpegURL\") ||\n    mediaElement.canPlayType(\"application/vnd.apple.mpegURL\")\n  )\n    mediaElement.src = src;\n  else if (hls.isSupported()) {\n    const hlsInstance = new hls();\n\n    hlsInstance.attachMedia(mediaElement);\n    hlsInstance.on(hls.Events.MEDIA_ATTACHED, function () {\n      hlsInstance.loadSource(src);\n    });\n\n    registerDestroy(() => hlsInstance.destroy());\n  }\n};\n","/* eslint-disable vue/no-unused-properties */\nimport { usePageLang } from \"@vuepress/client\";\nimport {\n  camelize,\n  defineComponent,\n  h,\n  nextTick,\n  onBeforeUnmount,\n  onMounted,\n  ref,\n} from \"vue\";\n\nimport { useSize } from \"../composables/size.js\";\nimport {\n  SUPPORTED_VIDEO_TYPES,\n  getTypeByUrl,\n  registerMseDash,\n  registerMseFlv,\n  registerMseHls,\n} from \"../utils/mse.js\";\n\nimport type Artplayer from \"artplayer\";\nimport type { Option as ArtPlayerInitOptions } from \"artplayer/types/option.js\";\nimport type { PropType, VNode } from \"vue\";\nimport type { ArtPlayerOptions } from \"../../shared/index.js\";\n\nconst BOOLEAN_TRUE_ATTRS = [\n  \"no-fullscreen\",\n  \"no-hotkey\",\n  \"no-playback-rate\",\n  \"no-setting\",\n  \"no-mutex\",\n  \"no-plays-inline\",\n] as const;\n\nconst BOOLEAN_FALSE_ATTRS = [\n  \"airplay\",\n  \"autoplay\",\n  \"aspect-ratio\",\n  \"auto-mini\",\n  \"auto-size\",\n  \"auto-orientation\",\n  \"auto-playback\",\n  \"fast-forward\",\n  \"flip\",\n  \"fullscreen-web\",\n  \"lock\",\n  \"loop\",\n  \"is-live\",\n  \"muted\",\n  \"mini-progress-bar\",\n  \"pip\",\n  \"screenshot\",\n  \"subtitle-offset\",\n] as const;\n\nconst SUPPORTED_LANG_NAME = [\"en\", \"pl\", \"cs\", \"es\", \"fa\"];\nconst SUPPORTED_LANG_CODE = [\"zh-cn\", \"zh-tw\"];\n\ntype KebabCaseToCamelCase<\n  S extends string,\n  Cap extends boolean = false\n> = S extends `${infer Head}-${infer Tail}`\n  ? `${Cap extends true ? Capitalize<Head> : Head}${KebabCaseToCamelCase<\n      Tail,\n      true\n    >}`\n  : Cap extends true\n  ? Capitalize<S>\n  : S;\n\ntype ArtPlayerBooleanOptionKey =\n  | (typeof BOOLEAN_TRUE_ATTRS extends readonly (infer T extends string)[]\n      ? T extends `no-${infer Key}`\n        ? KebabCaseToCamelCase<Key>\n        : never\n      : never)\n  | (typeof BOOLEAN_FALSE_ATTRS extends readonly (infer T extends string)[]\n      ? KebabCaseToCamelCase<T>\n      : never);\n\ndeclare const ART_PLAYER_OPTIONS: ArtPlayerOptions;\n\nconst getLang = (lang: string): string => {\n  const langCode = lang.toLowerCase();\n  const langName = langCode.split(\"-\")[0]!;\n\n  return SUPPORTED_LANG_CODE.includes(langCode)\n    ? langCode\n    : SUPPORTED_LANG_NAME.includes(langName)\n    ? langName\n    : langName === \"zh\"\n    ? \"zh-cn\"\n    : \"en\";\n};\n\nexport default defineComponent({\n  name: \"ArtPlayer\",\n\n  props: {\n    /**\n     * Video Source URL\n     *\n     * 视频源文件地址\n     */\n    src: {\n      type: String,\n      required: true,\n    },\n\n    /**\n     * Video Type\n     *\n     * 视频类型\n     */\n    type: {\n      type: String,\n      default: \"\",\n    },\n\n    /**\n     * Video poster\n     *\n     * 视频封面\n     */\n    poster: {\n      type: String,\n      default: \"\",\n    },\n\n    /**\n     * Video title\n     *\n     * 视频标题\n     */\n    title: {\n      type: String,\n      default: \"\",\n    },\n\n    /**\n     * Component width\n     *\n     * 组件宽度\n     */\n    width: {\n      type: [String, Number],\n      default: \"100%\",\n    },\n\n    /**\n     * Component height\n     *\n     * 组件高度\n     */\n    height: {\n      type: [String, Number],\n      default: undefined,\n    },\n\n    /**\n     * Component width / height ratio\n     *\n     * 组件长宽比\n     */\n    ratio: {\n      type: [String, Number],\n      default: 16 / 9,\n    },\n\n    /**\n     * ArtPlayer config\n     *\n     * ArtPlayer 配置\n     */\n    config: {\n      type: Object as PropType<Omit<ArtPlayerOptions, \"container\">>,\n      default: null,\n    },\n\n    /**\n     * Customize Artplayer\n     *\n     * 对 Artplayer 进行自定义\n     */\n    customPlayer: {\n      type: Function as PropType<\n        (\n          player: Artplayer\n        ) => Artplayer | void | Promise<Artplayer> | Promise<void>\n      >,\n\n      default: (player: Artplayer) => player,\n    },\n  },\n\n  setup(props, { attrs }) {\n    const lang = usePageLang();\n    const { el, width, height } = useSize<HTMLDivElement>(props, 0);\n\n    const template = ref(\"Loading...\");\n\n    let artPlayerInstance: Artplayer;\n\n    const getInitOptions = (): ArtPlayerInitOptions => {\n      const initOptions: ArtPlayerInitOptions = {\n        theme: \"#3eaf7c\",\n        ...ART_PLAYER_OPTIONS,\n        container: el.value!,\n        title: props.title,\n        poster: props.poster,\n        url: props.src,\n        type: props.type || getTypeByUrl(props.src),\n        lang: getLang(lang.value),\n        ...props.config,\n        // this option must be set true to avoid problems\n        useSSR: true,\n      };\n\n      const attrsKeys = Object.keys(attrs);\n\n      BOOLEAN_TRUE_ATTRS.forEach((config) => {\n        if (attrsKeys.includes(config))\n          initOptions[\n            <ArtPlayerBooleanOptionKey>camelize(config.replace(/^no-/, \"\"))\n          ] = false;\n      });\n      BOOLEAN_FALSE_ATTRS.forEach((config) => {\n        if (attrsKeys.includes(config))\n          initOptions[<ArtPlayerBooleanOptionKey>camelize(config)] = true;\n      });\n\n      // auto config mse\n      if (initOptions.type) {\n        const customType = (initOptions.customType ??= {});\n\n        if (SUPPORTED_VIDEO_TYPES.includes(initOptions.type.toLowerCase())) {\n          switch (initOptions.type) {\n            case \"m3u8\":\n            case \"hls\":\n              customType[initOptions.type] ??= (\n                video: HTMLVideoElement,\n                src: string,\n                player: Artplayer\n              ): Promise<void> =>\n                registerMseHls(video, src, (destroy) => {\n                  player.on(\"destroy\", destroy);\n                });\n              break;\n\n            case \"flv\":\n              customType[initOptions.type] ??= (\n                video: HTMLVideoElement,\n                src: string,\n                player: Artplayer\n              ): Promise<void> =>\n                registerMseFlv(video, src, (destroy) => {\n                  player.on(\"destroy\", destroy);\n                });\n              break;\n\n            case \"mpd\":\n            case \"dash\":\n              customType[initOptions.type] ??= (\n                video: HTMLVideoElement,\n                src: string,\n                player: Artplayer\n              ): Promise<void> =>\n                registerMseDash(video, src, (destroy) => {\n                  player.on(\"destroy\", destroy);\n                });\n              break;\n          }\n        } else\n          console.warn(\n            `[components]: ArtPlayer does not support current file type ${initOptions.type}!`\n          );\n      }\n\n      return initOptions;\n    };\n\n    // FIXME: Related issue https://github.com/zhw2590582/ArtPlayer/issues/450\n    onMounted(() => {\n      void import(\"artplayer\").then(async ({ default: Artplayer }) => {\n        template.value = Artplayer.html;\n\n        return nextTick().then(async () => {\n          const player = new Artplayer(getInitOptions());\n\n          artPlayerInstance = (await props.customPlayer(player)) || player;\n        });\n      });\n    });\n\n    onBeforeUnmount(() => {\n      artPlayerInstance?.destroy();\n    });\n\n    return (): VNode =>\n      h(\"div\", {\n        ref: el,\n        style: {\n          width: width.value,\n          height: height.value,\n        },\n        innerHTML: template.value,\n      });\n  },\n});\n"],"names":["getValue","value","isString","useSize","options","extraHeight","el","ref","width","computed","unref","height","getRadio","ratio","parsedRadio","getHeight","updateHeight","onMounted","isRef","watch","useEventListener","SUPPORTED_VIDEO_TYPES","getTypeByUrl","url","registerMseDash","mediaElement","src","registerDestroy","autoPlay","startTime","dashjs","dashPlayer","registerMseFlv","mpegts","flvPlayer","registerMseHls","hls","hlsInstance","BOOLEAN_TRUE_ATTRS","BOOLEAN_FALSE_ATTRS","SUPPORTED_LANG_NAME","SUPPORTED_LANG_CODE","getLang","lang","langCode","langName","ArtPlayer","defineComponent","player","props","attrs","usePageLang","template","artPlayerInstance","getInitOptions","_a","_b","_c","initOptions","attrsKeys","config","camelize","customType","video","destroy","Artplayer","nextTick","onBeforeUnmount","h"],"mappings":"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"}